# 光立方外设文档

>Music3D 组 ：任一&潘传宇
>
>author: 潘传宇
>
>2020.6.21

光立方（这里特指8\*8\*8的光立方，其他规格请参照商家文档）是一个基于三维LED点阵的显示模块，可以通过控制不同位置灯的亮暗来实现“三维显示”。

<img src=".\pic\cube1.jpg" style="zoom:67%;" />

## 光立方总体介绍

现在市面上通常的光立方结构是由一个单片机作为控制器来控制led点阵的，其作用在于将外界传入的串口信号解码并表现在每个led两端的电压上。对于控制一个光立方模块来说，我们需要做的就是将上位机（如FPGA）生成的控制信号通过串口输送给下位机（单片机），从而让其控制光立方显示。

## 外设购买

### 购买链接

我们组的光立方购买链接为：https://m.tb.cn/h.VLY9bzK?sm=0642d9

还有很多商家可以购买光立方成品，不限于上面这一家。但买之前一定要确认该光立方有没有RX/TX串口，且该串口可以外接上位机控制光立方。RX/TX串口示意如下：

<img src=".\pic\cube2.jpg" style="zoom: 67%;" />

p.s. 可能有些商家自己都不知道他卖的光立方有这个串口，这时候首先需要看光立方是否能够被外面程序控制，因为这个实现本质上依赖的也是usb转串口的输入；其次需要看到光立方完整图片以判断有无类似接口。

### 注意事项

- 光立方是一个还未统一接口协议的模块，因此不同商家的光立方接口是有一定差别的，不过大同小异；
- 不推荐手焊光立方，焊led对焊接技术要求比较高，而且费时费力，不容易找bug；
- 购买时卖家资料需要给全，一些测试程序对调试光立方有帮助；

## 光立方使用

### 电源

这里推荐直接使用光立方附带的电源线接通电源，不推荐用FPGA供电，因为FPGA有时供电不稳可能会导致光立方显示异常。

### 光立方调试

调试光立方建议购买“usb转UART串口”模块（如CP2102模块），并辅以串口调试工具（如SerialPro）。该工具可以接受和输出串口信号，可以通过串口调试工具向光立方输出信号，来测试如何控制光立方。具体的通信协议见“光立方通信协议”。

这里特别注意，usb转UART串口模块上的TX需接在光立方的RX上、RX需接在光立方的TX上。（TX发送RX接受）

<img src=".\pic\cube3.jpg" style="zoom: 33%;" />

### 接入fpga

FPGA引脚分配完成后，只需用杜邦线将串口信号从GPIO接口接出即可，同时接入光立方的RX口上。

## 光立方传输协议

**特别注意：不同光立方有不同的传输协议，以下协议仅针对购买链接中的光立方，其他光立方的传输协议需要根据商家给的示例程序自行摸索**

<img src=".\pic\coor.jpg" style="zoom:67%;" />

坐标系选取如上图所示，其中坐标原点对应图中“亮灯点”，在“上位机开关”按键正上方。任意一个led的位置可由一个三元组表示：`(x,y,z)`，其中x,y,z取值均为0~7。

光立方串口通信参数如下：

>波特率： 115200
>
>数据位：8
>
>校验位： 无
>
>停止位：1

以下按“16进制”收发数据类型（还可以使用“ASCII”）对光立方具体控制协议进行说明（这是需要发给光立方串口的信号）：

```
F2 //数据包起始码 
00 00 00 00 00 00 00 00 //y=0
00 00 00 00 00 00 00 00 //y=1
00 00 00 00 00 00 00 00 //y=2
00 00 00 00 00 00 00 00 //y=3
00 00 00 00 00 00 00 00 //y=4
00 00 00 00 00 00 00 00 //y=5
00 00 00 00 00 00 00 00 //y=6
00 00 00 00 00 00 00 00 //y=7
```

称上述这一数据块为一个“数据包”；一个数据包可以完全控制某一时刻光立方的点亮状态。数据包中的每一个数据（如`00`,`F2`）称为“数据元”，每个“数据元”由一个二位16进制数构成，在实际串口传输时即为一个传输单元（8位数据，1字节）。可以看出，一个“数据包”包含65个“数据元”（65字节）。

### 数据元的位置控制x和y：

上述数据包中，`F2`为数据包起始码。剩下64个数据元，每个控制一条纵向（z方向）的灯：例如，第(i,j)个数据元控制y=i,x=j上的led（i,j编号与行列式一致）。

### 数据元的具体值控制z：

对于每一个数据元，都是个二位16进制数，不妨设为`mn`，其中m,n:0~F；则亮灯位置为，将`mn`转化成二进制数后，"1"的位置（右边低位，低位代表z小）。例如：`01`转化成二进制数为`00000001`，因此仅有z=0灯亮，`12`转化成二进制数为`00010010`，因此有z=1, z=4处的灯亮。

